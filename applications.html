<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Service Applications - Admin Panel</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <style>
.navbar, .bg-primary, header, .site-header, .header, .custom-header, .section-header, .analytics-header {
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%) !important;
    color: #fff !important;
}
.brand-gradient-header {
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%) !important;
    color: #fff !important;
}
</style>
</head>
<body>
    <div class="container-fluid py-5">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-outline-danger btn-sm" onclick="logoutAdmin()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="text-primary">Service Applications</h1>
                        <div class="d-flex gap-2">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" onclick="filterApplications('all')" id="filterAll">
                                    <i class="fas fa-list"></i> All
                                </button>
                                <button class="btn btn-outline-warning" onclick="filterApplications('new')" id="filterNew">
                                    <i class="fas fa-star"></i> New
                                </button>
                                <button class="btn btn-outline-info" onclick="filterApplications('in-progress')" id="filterInProgress">
                                    <i class="fas fa-clock"></i> In Progress
                                </button>
                                <button class="btn btn-outline-success" onclick="filterApplications('completed')" id="filterCompleted">
                                    <i class="fas fa-check"></i> Completed
                                </button>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary" onclick="showAnalytics()">
                                    <i class="fas fa-chart-bar"></i> Analytics
                                </button>
                                <button class="btn btn-primary" onclick="exportApplications()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="totalApplications">0</h4>
                                            <p class="mb-0">Total Applications</p>
                                        </div>
                                        <i class="fas fa-file-alt fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="newApplications">0</h4>
                                            <p class="mb-0">New Applications</p>
                                        </div>
                                        <i class="fas fa-star fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="inProgressApplications">0</h4>
                                            <p class="mb-0">In Progress</p>
                                        </div>
                                        <i class="fas fa-clock fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="completedApplications">0</h4>
                                            <p class="mb-0">Completed</p>
                                        </div>
                                        <i class="fas fa-check fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="applicationsContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading applications...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Analytics & Reports</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Analytics Content -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Service Popularity</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="serviceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Status Distribution</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="statusChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Monthly Trends</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="trendChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Priority Distribution</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="priorityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Analytics Table -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Detailed Analytics</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Value</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsTableBody">
                                        <!-- Analytics data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportAnalytics()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="applicationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="applicationDetails">
                    <!-- Application details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="updateStatus('new')">
                                <i class="fas fa-star"></i> New
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="updateStatus('in-progress')">
                                <i class="fas fa-clock"></i> In Progress
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="updateStatus('completed')">
                                <i class="fas fa-check"></i> Completed
                            </button>
                        </div>
                        <div class="btn-group ms-2" role="group">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="updatePriority('high')">
                                <i class="fas fa-exclamation"></i> High
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="updatePriority('medium')">
                                <i class="fas fa-minus"></i> Medium
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="updatePriority('low')">
                                <i class="fas fa-arrow-down"></i> Low
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let applications = [];
        let currentApplicationId = null;
        let currentFilter = 'all';

        // --- Simple Admin Auth Guard ---
        const ADMIN_TOKEN_KEY = 'adminAuthToken';
        const REQUIRED_TOKEN = 'idh-admin-2025'; // Change this to a secure value

        function isAuthenticated() {
            try {
                const token = localStorage.getItem(ADMIN_TOKEN_KEY);
                return token === REQUIRED_TOKEN;
            } catch (_) { return false; }
        }

        function requireAuthOrRedirect() {
            if (!isAuthenticated()) {
                window.location.href = 'admin-login.html';
            }
        }

        function logoutAdmin() {
            localStorage.removeItem(ADMIN_TOKEN_KEY);
            window.location.href = 'index.html';
        }

        // Load applications from localStorage
        function loadApplications() {
            try {
                const stored = localStorage.getItem('serviceApplications');
                applications = stored ? JSON.parse(stored) : [];
                
                // Ensure all applications have required fields
                applications = applications.map(app => ({
                    ...app,
                    status: app.status || 'new',
                    priority: app.priority || 'medium',
                    id: app.id || Date.now() + Math.random().toString(36).substr(2, 9)
                }));
                
                updateStatistics();
                displayApplications();
            } catch (e) {
                console.error('Error loading applications:', e);
                document.getElementById('applicationsContainer').innerHTML = 
                    '<div class="alert alert-danger">Error loading applications from storage.</div>';
            }
        }

        // Update statistics
        function updateStatistics() {
            const total = applications.length;
            const newApps = applications.filter(app => app.status === 'new').length;
            const inProgress = applications.filter(app => app.status === 'in-progress').length;
            const completed = applications.filter(app => app.status === 'completed').length;
            
            document.getElementById('totalApplications').textContent = total;
            document.getElementById('newApplications').textContent = newApps;
            document.getElementById('inProgressApplications').textContent = inProgress;
            document.getElementById('completedApplications').textContent = completed;
        }

        // Filter applications
        function filterApplications(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1).replace('-', '')).classList.add('active');
            
            displayApplications();
        }

        // Display applications
        function displayApplications() {
            const container = document.getElementById('applicationsContainer');
            
            // Filter applications based on current filter
            let filteredApps = applications;
            if (currentFilter !== 'all') {
                filteredApps = applications.filter(app => app.status === currentFilter);
            }
            
            if (filteredApps.length === 0) {
                const message = currentFilter === 'all' ? 
                    'No applications yet' : 
                    `No ${currentFilter.replace('-', ' ')} applications`;
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>${message}</h4>
                        <p>Service applications will appear here once visitors start submitting forms.</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';
            
            filteredApps.forEach((app, index) => {
                const originalIndex = applications.findIndex(a => a.id === app.id);
                const statusClass = getStatusClass(app.status);
                const priorityClass = getPriorityClass(app.priority);
                const statusBadge = getStatusBadge(app.status);
                const priorityBadge = getPriorityBadge(app.priority);
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card ${statusClass} h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${app.service}</h6>
                                <div class="d-flex gap-1">
                                    ${priorityBadge}
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">${app.name}</h6>
                                <p class="card-text">
                                    <i class="fas fa-envelope"></i> ${app.email}<br>
                                    ${app.phone ? `<i class="fas fa-phone"></i> ${app.phone}<br>` : ''}
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${app.timestamp}
                                    </small>
                                </p>
                                <p class="card-text">${app.message ? app.message.substring(0, 100) + '...' : 'No message'}</p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm" onclick="viewApplication(${originalIndex})">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Helper functions for status and priority styling
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'border-warning';
                case 'in-progress': return 'border-info';
                case 'completed': return 'border-success';
                default: return 'border-secondary';
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'high': return 'border-danger';
                case 'medium': return 'border-warning';
                case 'low': return 'border-success';
                default: return 'border-secondary';
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="badge bg-warning">New</span>',
                'in-progress': '<span class="badge bg-info">In Progress</span>',
                'completed': '<span class="badge bg-success">Completed</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }

        function getPriorityBadge(priority) {
            const badges = {
                'high': '<span class="badge bg-danger">High</span>',
                'medium': '<span class="badge bg-warning">Medium</span>',
                'low': '<span class="badge bg-success">Low</span>'
            };
            return badges[priority] || '<span class="badge bg-secondary">Medium</span>';
        }

        // View application details
        function viewApplication(index) {
            const app = applications[index];
            currentApplicationId = index;
            
            const details = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Contact Information</h6>
                        <p><strong>Name:</strong> ${app.name}</p>
                        <p><strong>Email:</strong> <a href="mailto:${app.email}">${app.email}</a></p>
                        <p><strong>Phone:</strong> ${app.phone || 'Not provided'}</p>
                        <p><strong>Service:</strong> ${app.service}</p>
                        <p><strong>Submitted:</strong> ${app.timestamp}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Message</h6>
                        <div class="border p-3 rounded">
                            ${app.message ? app.message.replace(/\n/g, '<br>') : 'No message provided'}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Quick Actions</h6>
                        <a href="mailto:${app.email}?subject=Re: ${app.service} Application&body=Hi ${app.name},%0D%0A%0D%0AThank you for your interest in our ${app.service} service.%0D%0A%0D%0A" 
                           class="btn btn-success me-2">
                            <i class="fas fa-envelope"></i> Reply via Email
                        </a>
                        ${app.phone ? `<a href="tel:${app.phone}" class="btn btn-primary me-2">
                            <i class="fas fa-phone"></i> Call
                        </a>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('applicationDetails').innerHTML = details;
            
            const modal = new bootstrap.Modal(document.getElementById('applicationModal'));
            modal.show();
        }

        // Update application status
        function updateStatus(status) {
            if (currentApplicationId !== null) {
                applications[currentApplicationId].status = status;
                localStorage.setItem('serviceApplications', JSON.stringify(applications));
                updateStatistics();
                displayApplications();
                
                // Show success message
                const statusMessages = {
                    'new': 'marked as New',
                    'in-progress': 'marked as In Progress',
                    'completed': 'marked as Completed'
                };
                
                // Create temporary success message
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> Application ${statusMessages[status]}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(successDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
        }

        // Update application priority
        function updatePriority(priority) {
            if (currentApplicationId !== null) {
                applications[currentApplicationId].priority = priority;
                localStorage.setItem('serviceApplications', JSON.stringify(applications));
                displayApplications();
                
                // Show success message
                const priorityMessages = {
                    'high': 'set to High priority',
                    'medium': 'set to Medium priority',
                    'low': 'set to Low priority'
                };
                
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-info alert-dismissible fade show position-fixed';
                successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                successDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i> Priority ${priorityMessages[priority]}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
        }

        // Export applications to CSV
        function exportApplications() {
            if (applications.length === 0) {
                alert('No applications to export.');
                return;
            }

            let csv = 'Name,Email,Phone,Service,Message,Timestamp,Status,Priority,ID\n';
            
            applications.forEach(app => {
                const row = [
                    `"${app.name}"`,
                    `"${app.email}"`,
                    `"${app.phone || ''}"`,
                    `"${app.service}"`,
                    `"${(app.message || '').replace(/"/g, '""')}"`,
                    `"${app.timestamp}"`,
                    `"${app.status || 'new'}"`,
                    `"${app.priority || 'medium'}"`,
                    `"${app.id || ''}"`
                ].join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `service-applications-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Listen for new applications
        window.addEventListener('storage', function(e) {
            if (e.key === 'serviceApplication') {
                loadApplications();
            }
        });

        // Analytics functions
        function showAnalytics() {
            const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
            modal.show();
            
            // Generate analytics after modal is shown
            setTimeout(() => {
                generateAnalytics();
            }, 300);
        }

        function generateAnalytics() {
            if (applications.length === 0) {
                document.getElementById('analyticsTableBody').innerHTML = 
                    '<tr><td colspan="3" class="text-center">No data available for analytics</td></tr>';
                return;
            }

            // Service popularity analysis
            const serviceStats = {};
            const statusStats = { new: 0, 'in-progress': 0, completed: 0 };
            const priorityStats = { high: 0, medium: 0, low: 0 };
            const monthlyStats = {};

            applications.forEach(app => {
                // Service popularity
                serviceStats[app.service] = (serviceStats[app.service] || 0) + 1;
                
                // Status distribution
                statusStats[app.status] = (statusStats[app.status] || 0) + 1;
                
                // Priority distribution
                priorityStats[app.priority] = (priorityStats[app.priority] || 0) + 1;
                
                // Monthly trends
                const date = new Date(app.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyStats[monthKey] = (monthlyStats[monthKey] || 0) + 1;
            });

            // Create charts
            createServiceChart(serviceStats);
            createStatusChart(statusStats);
            createPriorityChart(priorityStats);
            createTrendChart(monthlyStats);
            
            // Populate analytics table
            populateAnalyticsTable(serviceStats, statusStats, priorityStats, monthlyStats);
        }

        function createServiceChart(serviceStats) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            const labels = Object.keys(serviceStats);
            const data = Object.values(serviceStats);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#f80f0f', '#34AD54', '#007bff', '#ffc107', 
                            '#17a2b8', '#6f42c1', '#fd7e14', '#20c997'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createStatusChart(statusStats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['New', 'In Progress', 'Completed'],
                    datasets: [{
                        data: [statusStats.new, statusStats['in-progress'], statusStats.completed],
                        backgroundColor: ['#ffc107', '#17a2b8', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createPriorityChart(priorityStats) {
            const ctx = document.getElementById('priorityChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Applications',
                        data: [priorityStats.high, priorityStats.medium, priorityStats.low],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createTrendChart(monthlyStats) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const sortedMonths = Object.keys(monthlyStats).sort();
            const data = sortedMonths.map(month => monthlyStats[month]);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Applications',
                        data: data,
                        borderColor: '#f80f0f',
                        backgroundColor: 'rgba(248, 15, 15, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function populateAnalyticsTable(serviceStats, statusStats, priorityStats, monthlyStats) {
            const tbody = document.getElementById('analyticsTableBody');
            const total = applications.length;
            
            let html = '';
            
            // Service statistics
            Object.entries(serviceStats).forEach(([service, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `<tr>
                    <td>${service}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                </tr>`;
            });
            
            // Status statistics
            html += `<tr><td colspan="3" class="table-secondary"><strong>Status Distribution</strong></td></tr>`;
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `<tr>
                    <td>${status.charAt(0).toUpperCase() + status.slice(1)}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                </tr>`;
            });
            
            // Priority statistics
            html += `<tr><td colspan="3" class="table-secondary"><strong>Priority Distribution</strong></td></tr>`;
            Object.entries(priorityStats).forEach(([priority, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `<tr>
                    <td>${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                </tr>`;
            });
            
            // Monthly statistics
            html += `<tr><td colspan="3" class="table-secondary"><strong>Monthly Trends</strong></td></tr>`;
            const sortedMonths = Object.keys(monthlyStats).sort();
            sortedMonths.forEach(month => {
                const count = monthlyStats[month];
                const percentage = ((count / total) * 100).toFixed(1);
                html += `<tr>
                    <td>${month}</td>
                    <td>${count}</td>
                    <td>${percentage}%</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function exportAnalytics() {
            if (applications.length === 0) {
                alert('No data available for analytics export.');
                return;
            }

            // Create analytics report
            const serviceStats = {};
            const statusStats = { new: 0, 'in-progress': 0, completed: 0 };
            const priorityStats = { high: 0, medium: 0, low: 0 };
            const monthlyStats = {};

            applications.forEach(app => {
                serviceStats[app.service] = (serviceStats[app.service] || 0) + 1;
                statusStats[app.status] = (statusStats[app.status] || 0) + 1;
                priorityStats[app.priority] = (priorityStats[app.priority] || 0) + 1;
                
                const date = new Date(app.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyStats[monthKey] = (monthlyStats[monthKey] || 0) + 1;
            });

            let report = `Service Applications Analytics Report\n`;
            report += `Generated on: ${new Date().toLocaleString()}\n\n`;
            
            report += `TOTAL APPLICATIONS: ${applications.length}\n\n`;
            
            report += `SERVICE POPULARITY:\n`;
            Object.entries(serviceStats).forEach(([service, count]) => {
                const percentage = ((count / applications.length) * 100).toFixed(1);
                report += `${service}: ${count} (${percentage}%)\n`;
            });
            
            report += `\nSTATUS DISTRIBUTION:\n`;
            Object.entries(statusStats).forEach(([status, count]) => {
                const percentage = ((count / applications.length) * 100).toFixed(1);
                report += `${status}: ${count} (${percentage}%)\n`;
            });
            
            report += `\nPRIORITY DISTRIBUTION:\n`;
            Object.entries(priorityStats).forEach(([priority, count]) => {
                const percentage = ((count / applications.length) * 100).toFixed(1);
                report += `${priority}: ${count} (${percentage}%)\n`;
            });
            
            report += `\nMONTHLY TRENDS:\n`;
            const sortedMonths = Object.keys(monthlyStats).sort();
            sortedMonths.forEach(month => {
                const count = monthlyStats[month];
                const percentage = ((count / applications.length) * 100).toFixed(1);
                report += `${month}: ${count} (${percentage}%)\n`;
            });

            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Load applications on page load (with auth guard)
        document.addEventListener('DOMContentLoaded', function() {
            requireAuthOrRedirect();
            loadApplications();
        });
    </script>
</body>
</html>
